<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›æ„æ„æ€å·¥å…·</title>
    <style>
        /* --- åŸºç¡€ä¸å˜é‡å®šä¹‰ (v2.0 - ç°ä»£/ç´§å‡‘) --- */
        :root {
            --primary-color: #0D9488; /* æ·±é’è‰² */
            --primary-color-dark: #0F766E;
            --background-color: #F9FAFB; /* æš–ç°è‰²èƒŒæ™¯ */
            --surface-color: #FFFFFF;
            --text-color-primary: #1F2937; /* æ·±ç°è‰²æ–‡æœ¬ */
            --text-color-secondary: #6B7280; /* ä¸­ç°è‰²æ–‡æœ¬ */
            --text-color-light: #9CA3AF;
            --border-color: #E5E7EB;
            --warning-color: #E11D48;
            --success-color: #16A34A;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --border-radius: 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--background-color);
            line-height: 1.5;
            color: var(--text-color-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- å¸ƒå±€ (æ›´ç´§å‡‘) --- */
        .container {
            max-width: 960px; /* å‡å°æœ€å¤§å®½åº¦ */
            margin: 0 auto;
            display: flex;
            min-height: 100vh;
        }

        .main {
            flex: 1;
            padding: 40px; /* å‡å°å†…è¾¹è· */
            background: var(--surface-color);
        }
        
        /* --- å¤´éƒ¨ä¸è¿›åº¦æ¡ --- */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 28px; /* å‡å°å­—å· */
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            color: var(--text-color-secondary);
            font-size: 15px;
        }

        .progress {
            height: 4px;
            background: #F3F4F6;
            margin: 24px auto 0;
            border-radius: 2px;
            max-width: 320px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            border-radius: 2px;
        }

        /* --- æ­¥éª¤ä¸åˆ‡æ¢åŠ¨ç”» --- */
        .step {
            display: none;
        }

        .step.active {
            display: block;
        }
        
        .step.animate-in { animation: fadeIn 0.5s ease-out forwards; }
        .step.animate-out { animation: fadeOut 0.3s ease-in forwards; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* --- æ­¥éª¤å†…éƒ¨æ ·å¼ --- */
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .step-number {
            width: 36px;
            height: 36px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .step-info h3 {
            font-size: 20px;
            color: var(--text-color-primary);
            margin-bottom: 2px;
        }

        .step-info p {
            color: var(--text-color-secondary);
            font-size: 14px;
        }

        .timer {
            margin-left: auto;
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 600;
            background: #F0FDFA;
            padding: 5px 12px;
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .timer.warning {
            color: var(--warning-color);
            background: #FFF1F2;
        }

        /* --- è¡¨å•å…ƒç´  --- */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color-primary);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            background: #F9FAFB;
            transition: all 0.25s ease-out;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--surface-color);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .form-group textarea {
            min-height: 90px;
        }

        /* --- æç¤ºä¸å»ºè®® --- */
        .suggestions {
            margin-top: 12px;
            padding: 10px 12px;
            background: #F9FAFB;
            border-radius: 4px;
        }

        .suggestions h4 {
            font-size: 13px;
            color: var(--text-color-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .suggestion-item {
            font-size: 13px;
            color: var(--text-color-light);
            margin-bottom: 4px;
            cursor: pointer;
            padding: 3px 0;
            transition: color 0.2s ease;
        }

        .suggestion-item:hover {
            color: var(--primary-color);
        }

        /* --- æŒ‰é’® --- */
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-out;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            background: var(--primary-color-dark);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-color-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
            color: var(--text-color-primary);
        }

        /* --- ç»“æœé¡µ --- */
        .result {
            background: #F9FAFB;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-top: 20px;
        }

        .result h3 {
            color: var(--text-color-primary);
            margin-bottom: 20px;
            font-size: 18px;
        }

        .result-item {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 12px;
            border-left: 3px solid var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .result-label {
            font-weight: 600;
            color: var(--text-color-primary);
            margin-bottom: 6px;
            font-size: 14px;
        }

        .result-content {
            color: var(--text-color-secondary);
            font-size: 14px;
            white-space: pre-wrap;
        }

        /* --- æµ®åŠ¨æ€»ç»“çª—å£ (æ›´ç´§å‡‘) --- */
        .floating-summary {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 260px; /* å‡å°å®½åº¦ */
            max-height: 400px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .floating-summary.visible { transform: translateX(0); }

        .floating-header {
            padding: 8px 12px;
            background: #F9FAFB;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .floating-header h3 {
            font-size: 13px;
            color: var(--text-color-primary);
            margin: 0;
            font-weight: 600;
        }

        .close-btn {
            background: none; border: none; font-size: 18px;
            color: var(--text-color-light); cursor: pointer; padding: 2px;
            width: 22px; height: 22px; display: flex; align-items: center;
            justify-content: center; border-radius: 4px; transition: all 0.2s ease;
        }

        .close-btn:hover { background: #E5E7EB; color: var(--text-color-primary); }

        .floating-content {
            padding: 8px;
            overflow-y: auto;
        }

        .step-summary {
            margin-bottom: 6px;
            padding: 8px;
            background: #F9FAFB;
            border-radius: 4px;
            border-left: 2px solid var(--primary-color);
        }
        .step-summary:last-child { margin-bottom: 0; }

        .step-title {
            font-weight: 600;
            color: var(--text-color-primary);
            margin-bottom: 3px;
            font-size: 12px;
        }

        .step-content {
            color: var(--text-color-secondary);
            font-size: 12px;
            line-height: 1.4;
        }
        
        /* --- æµ®åŠ¨åˆ‡æ¢æŒ‰é’® --- */
        .toggle-summary {
            position: fixed; top: 20px; right: 20px;
            background: var(--primary-color); color: white; border: none;
            width: 40px; height: 40px; border-radius: 20px;
            font-size: 18px; cursor: pointer; box-shadow: var(--shadow-md);
            z-index: 999; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease; transform-origin: center;
        }

        .toggle-summary:hover {
            background: var(--primary-color-dark);
            transform: scale(1.1);
        }
        
        .toggle-summary.hidden { transform: scale(0); opacity: 0; }

        /* --- å“åº”å¼è®¾è®¡ --- */
        @media (max-width: 768px) {
            .main { padding: 25px 20px; }
            .header h1 { font-size: 24px; }
            .step-header { flex-direction: column; align-items: flex-start; }
            .timer { margin-left: 0; margin-top: 15px; }
            .floating-summary { width: 240px; right: 15px; top: 15px; }
            .toggle-summary { right: 15px; top: 15px; }
            .buttons { flex-direction: column-reverse; gap: 10px; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æµ®åŠ¨æ€»ç»“çª—å£ -->
        <div class="floating-summary" id="floatingSummary">
            <div class="floating-header">
                <h3>æ„æ€è®°å½•</h3>
                <button class="close-btn" onclick="toggleSummary()">Ã—</button>
            </div>
            <div class="floating-content" id="floatingContent">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åˆ‡æ¢æŒ‰é’® -->
        <button class="toggle-summary hidden" id="toggleBtn" onclick="toggleSummary()">ğŸ“</button>

        <div class="main">
            <div class="header">
                <h1>åˆ›æ„æ„æ€å·¥å…·</h1>
                <p>ä»å¸¸è§„åˆ°ç‹¬ç‰¹çš„20åˆ†é’Ÿæ„æ€æ³•</p>
                <div class="progress">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- å¼€å§‹é¡µ -->
            <div class="step active" id="step0">
                <div class="step-header">
                    <div class="step-number">0</div>
                    <div class="step-info">
                        <h3>ç¡®å®šä¸»é¢˜</h3>
                        <p>ä½ æƒ³åˆ›ä½œä»€ä¹ˆï¼Ÿ</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="theme">åˆ›ä½œä¸»é¢˜</label>
                    <input type="text" id="theme" placeholder="ä¾‹å¦‚ï¼šèŠ±ç«å¤§ä¼šã€å’–å•¡åº—ã€é›¨å¤œ...">
                </div>
                <div class="buttons">
                    <div></div>
                    <button class="btn btn-primary" onclick="nextStep()">å¼€å§‹æ„æ€</button>
                </div>
            </div>

            <!-- ç¬¬1æ­¥ï¼šé€‰å®šé”šç‚¹ -->
            <div class="step" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-info">
                        <h3>é€‰å®šæ ¸å¿ƒé”šç‚¹</h3>
                        <p>é€‰æ‹©ä¸€ä¸ªå…·ä½“çš„ç‰©å“ã€åœ°ç‚¹æˆ–äººç‰©ä½œä¸ºæ•…äº‹æ ¸å¿ƒ</p>
                    </div>
                    <div class="timer" id="timer1">3:00</div>
                </div>
                <div class="form-group">
                    <label for="anchor">æ ¸å¿ƒé”šç‚¹</label>
                    <input type="text" id="anchor" placeholder="ä¸€ä¸ªå…·ä½“çš„ç‰©å“ã€åœ°ç‚¹æˆ–äººç‰©">
                    <div class="suggestions">
                        <h4>æç¤ºï¼š</h4>
                        <div class="suggestion-item" onclick="fillSuggestion('anchor', 'ä¸€ä»¶æ—§è¡£æœ')">â€¢ ä¸€ä»¶æ—§è¡£æœ</div>
                        <div class="suggestion-item" onclick="fillSuggestion('anchor', 'ä¸€æŠŠé›¨ä¼')">â€¢ ä¸€æŠŠé›¨ä¼</div>
                        <div class="suggestion-item" onclick="fillSuggestion('anchor', 'ä¸€å¼ è€ç…§ç‰‡')">â€¢ ä¸€å¼ è€ç…§ç‰‡</div>
                        <div class="suggestion-item" onclick="fillSuggestion('anchor', 'ä¸€ä¸ªç‰¹å®šçš„åº§ä½')">â€¢ ä¸€ä¸ªç‰¹å®šçš„åº§ä½</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="anchorReason">ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªï¼Ÿ</label>
                    <textarea id="anchorReason" placeholder="è¿™ä¸ªé”šç‚¹æœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼Ÿ"></textarea>
                </div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ (5åˆ†é’Ÿ)</button>
                </div>
            </div>

            <!-- ç¬¬2æ­¥ï¼šæ„å¤–å±æ€§ -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-info">
                        <h3>èµ‹äºˆæ„å¤–å±æ€§</h3>
                        <p>ç»™ä½ çš„é”šç‚¹ä¸€ä¸ªä¸å¯»å¸¸çš„èƒŒæ™¯æˆ–ç‰¹å¾</p>
                    </div>
                    <div class="timer" id="timer2">5:00</div>
                </div>
                <div class="form-group">
                    <label for="unexpectedAttr">æ„å¤–å±æ€§</label>
                    <textarea id="unexpectedAttr" placeholder="è¿™ä¸ªé”šç‚¹æœ‰ä»€ä¹ˆæ„å¤–çš„æ¥æºã€ç”¨é€”æˆ–å«ä¹‰ï¼Ÿ"></textarea>
                    <div class="suggestions">
                        <h4>æ€è€ƒæ–¹å‘ï¼š</h4>
                        <div class="suggestion-item" onclick="fillSuggestion('unexpectedAttr', 'å®ƒå±äºæˆ‘ä»æœªè§è¿‡çš„ç¥–çˆ¶ï¼Œæ˜¯ä»–ç•™ä¸‹çš„å”¯ä¸€é—ç‰©ã€‚')">â€¢ å®ƒå±äºä»€ä¹ˆç‰¹æ®Šçš„äººï¼Ÿ</div>
                        <div class="suggestion-item" onclick="fillSuggestion('unexpectedAttr', 'å®ƒæ›¾åœ¨ä¸€æ¬¡è‘—åçš„å†å²äº‹ä»¶ä¸­å‡ºç°è¿‡ã€‚')">â€¢ å®ƒæœ‰ä»€ä¹ˆéšè—çš„å†å²ï¼Ÿ</div>
                        <div class="suggestion-item" onclick="fillSuggestion('unexpectedAttr', 'å®ƒå…¶å®æ˜¯ä¸€ä¸ªç”¨æ¥ä¼ é€’ç§˜å¯†ä¿¡æ¯çš„å·¥å…·ã€‚')">â€¢ å®ƒçš„çœŸå®èº«ä»½/ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ</div>
                        <div class="suggestion-item" onclick="fillSuggestion('unexpectedAttr', 'å®ƒä»£è¡¨ç€ä¸€ä¸ªå·²ç»æ— æ³•å…‘ç°çš„æ‰¿è¯ºã€‚')">â€¢ å®ƒä»£è¡¨äº†ä»€ä¹ˆç‰¹æ®Šå«ä¹‰ï¼Ÿ</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="relationship">äººç‰©å…³ç³»</label>
                    <textarea id="relationship" placeholder="è¿™ä¸ªå±æ€§å¦‚ä½•å½±å“äººç‰©ä¹‹é—´çš„å…³ç³»ï¼Ÿ"></textarea>
                </div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ (5åˆ†é’Ÿ)</button>
                </div>
            </div>

            <!-- ç¬¬3æ­¥ï¼šæ°›å›´è¥é€  -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-info">
                        <h3>æ°›å›´è¥é€ </h3>
                        <p>è®¾ç½®å‰æœŸæ°›å›´ï¼Œè®©è§‚ä¼—äº§ç”ŸæŸç§é¢„æœŸ</p>
                    </div>
                    <div class="timer" id="timer3">5:00</div>
                </div>
                <div class="form-group">
                    <label for="atmosphere">å‰æœŸæ°›å›´</label>
                    <textarea id="atmosphere" placeholder="ä½ æƒ³è¥é€ ä»€ä¹ˆæ ·çš„æ°›å›´ï¼Ÿè§‚ä¼—ä¼šæœ‰ä»€ä¹ˆæ„Ÿå—ï¼Ÿ"></textarea>
                </div>
                <div class="form-group">
                    <label for="expectation">è§‚ä¼—é¢„æœŸ</label>
                    <textarea id="expectation" placeholder="åœ¨è¿™ç§æ°›å›´ä¸‹ï¼Œè§‚ä¼—ä¼šæœŸå¾…å‘ç”Ÿä»€ä¹ˆï¼Ÿ"></textarea>
                    <div class="suggestions">
                        <h4>å¸¸è§é¢„æœŸï¼š</h4>
                        <div class="suggestion-item" onclick="fillSuggestion('expectation', 'ä¸€åœºæµªæ¼«çš„é‚‚é€…å³å°†å‘ç”Ÿã€‚')">â€¢ æµªæ¼«çš„é‚‚é€…</div>
                        <div class="suggestion-item" onclick="fillSuggestion('expectation', 'ä¸»è§’ä¼šé€šè¿‡è¿™ä¸ªç‰©å“æ‰¾å›ä¸€æ®µæ¸©é¦¨çš„å›å¿†ã€‚')">â€¢ æ¸©é¦¨çš„å›å¿†</div>
                        <div class="suggestion-item" onclick="fillSuggestion('expectation', 'ä¸»è§’æœ€ç»ˆä¼šå…‹æœå›°éš¾ï¼Œè·å¾—æˆåŠŸã€‚')">â€¢ æˆåŠŸçš„ç»“å±€</div>
                        <div class="suggestion-item" onclick="fillSuggestion('expectation', 'ç ´è£‚çš„å…³ç³»ä¼šå› æ­¤å¾—åˆ°ä¿®å¤ã€‚')">â€¢ å’Œè°çš„å…³ç³»</div>
                    </div>
                </div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ (7åˆ†é’Ÿ)</button>
                </div>
            </div>

            <!-- ç¬¬4æ­¥ï¼šåè½¬è®¾è®¡ -->
            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-info">
                        <h3>åè½¬è®¾è®¡</h3>
                        <p>åœ¨å“ªä¸ªç‚¹æ‰“ç ´è§‚ä¼—çš„é¢„æœŸï¼Ÿ</p>
                    </div>
                    <div class="timer" id="timer4">7:00</div>
                </div>
                <div class="form-group">
                    <label for="twistPoint">åè½¬ç‚¹</label>
                    <textarea id="twistPoint" placeholder="ä»€ä¹ˆæ—¶å€™æ­ç¤ºçœŸç›¸ï¼Ÿé€šè¿‡ä»€ä¹ˆæ–¹å¼ï¼Ÿ"></textarea>
                </div>
                <div class="form-group">
                    <label for="twistContent">åè½¬å†…å®¹</label>
                    <textarea id="twistContent" placeholder="çœŸç›¸æ˜¯ä»€ä¹ˆï¼Ÿä¸é¢„æœŸæœ‰ä»€ä¹ˆå·®è·ï¼Ÿ"></textarea>
                </div>
                <div class="form-group">
                    <label for="emotionArc">æƒ…ç»ªå¼§çº¿</label>
                    <textarea id="emotionArc" placeholder="ä»å¼€å§‹åˆ°ç»“æŸï¼Œä¸»è§’æˆ–è§‚ä¼—çš„æƒ…ç»ªå¦‚ä½•å˜åŒ–ï¼Ÿä¾‹å¦‚ï¼šå¹³é™ -> æœŸå¾… -> éœ‡æƒŠ -> æ‚²ä¼¤ -> é‡Šç„¶"></textarea>
                </div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" onclick="generateResult()">ç”Ÿæˆç»“æœ</button>
                </div>
            </div>

            <!-- ç»“æœé¡µ -->
            <div class="step" id="step5">
                <div class="step-header">
                    <div class="step-number" style="background: var(--success-color);">âœ“</div>
                    <div class="step-info">
                        <h3>æ„æ€å®Œæˆ</h3>
                        <p>ä½ çš„ç‹¬ç‰¹åˆ›æ„å·²ç»æˆå‹</p>
                    </div>
                </div>
                <div class="result" id="finalResult">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="exportResult()">å¯¼å‡ºæ„æ€ (TXT)</button>
                    <button class="btn btn-primary" onclick="restart()">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let data = {};
        let timers = {};

        function updateProgress() {
            const progress = (currentStep / 5) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function updateSidebar() {
            const floatingContent = document.getElementById('floatingContent');
            const toggleBtn = document.getElementById('toggleBtn');
            
            floatingContent.innerHTML = '';

            const items = [];
            if (data.theme) items.push(['ä¸»é¢˜', data.theme]);
            if (data.anchor) items.push(['æ ¸å¿ƒé”šç‚¹', data.anchor]);
            if (data.anchorReason) items.push(['é€‰æ‹©ç†ç”±', data.anchorReason]);
            if (data.unexpectedAttr) items.push(['æ„å¤–å±æ€§', data.unexpectedAttr]);
            if (data.relationship) items.push(['äººç‰©å…³ç³»', data.relationship]);
            if (data.atmosphere) items.push(['å‰æœŸæ°›å›´', data.atmosphere]);
            if (data.expectation) items.push(['è§‚ä¼—é¢„æœŸ', data.expectation]);
            if (data.twistPoint) items.push(['åè½¬ç‚¹', data.twistPoint]);
            if (data.twistContent) items.push(['åè½¬å†…å®¹', data.twistContent]);
            if (data.emotionArc) items.push(['æƒ…ç»ªå¼§çº¿', data.emotionArc]);

            if (items.length > 0) {
                toggleBtn.classList.remove('hidden');
            } else {
                toggleBtn.classList.add('hidden');
            }

            items.forEach(([title, content]) => {
                const item = document.createElement('div');
                item.className = 'step-summary';
                item.innerHTML = `
                    <div class="step-title">${title}</div>
                    <div class="step-content">${truncateText(content, 45)}</div>
                `;
                floatingContent.appendChild(item);
            });
        }

        function toggleSummary() {
            document.getElementById('floatingSummary').classList.toggle('visible');
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function showStep(stepIndex) {
            const currentActiveStep = document.querySelector('.step.active');
            
            if (currentActiveStep && currentActiveStep.id !== `step${stepIndex}`) {
                currentActiveStep.classList.add('animate-out');
                setTimeout(() => {
                    currentActiveStep.classList.remove('active', 'animate-out');
                    
                    const nextStepEl = document.getElementById(`step${stepIndex}`);
                    nextStepEl.classList.add('active', 'animate-in');
                    
                    setTimeout(() => {
                        nextStepEl.classList.remove('animate-in');
                    }, 500);

                }, 300);
            } else {
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                document.getElementById(`step${stepIndex}`).classList.add('active');
            }
            
            updateProgress();
            updateSidebar();
        }

        function startTimer(step, minutes) {
            if (timers[step]) clearInterval(timers[step]);
            
            let seconds = minutes * 60;
            const timerEl = document.getElementById(`timer${step}`);
            timerEl.classList.remove('warning');
            
            timers[step] = setInterval(() => {
                if (seconds < 0) {
                    clearInterval(timers[step]);
                    timerEl.textContent = 'æ—¶é—´åˆ°!';
                    return;
                }

                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                if (seconds <= 30) {
                    timerEl.classList.add('warning');
                }
                
                seconds--;
            }, 1000);
        }

        function stopAllTimers() {
             Object.values(timers).forEach(timer => clearInterval(timer));
             timers = {};
        }
        
        function collectDataForStep(step) {
            if (step === 0) data.theme = document.getElementById('theme').value.trim();
            else if (step === 1) {
                data.anchor = document.getElementById('anchor').value.trim();
                data.anchorReason = document.getElementById('anchorReason').value.trim();
            } else if (step === 2) {
                data.unexpectedAttr = document.getElementById('unexpectedAttr').value.trim();
                data.relationship = document.getElementById('relationship').value.trim();
            } else if (step === 3) {
                data.atmosphere = document.getElementById('atmosphere').value.trim();
                data.expectation = document.getElementById('expectation').value.trim();
            } else if (step === 4) {
                data.twistPoint = document.getElementById('twistPoint').value.trim();
                data.twistContent = document.getElementById('twistContent').value.trim();
                data.emotionArc = document.getElementById('emotionArc').value.trim();
            }
        }

        function nextStep() {
            collectDataForStep(currentStep);

            if (currentStep === 0 && !data.theme) { alert('è¯·è¾“å…¥åˆ›ä½œä¸»é¢˜'); return; }
            if (currentStep === 1 && !data.anchor) { alert('è¯·è¾“å…¥æ ¸å¿ƒé”šç‚¹'); return; }

            if (currentStep < 5) {
                currentStep++;
                showStep(currentStep);
            }
            
            if (currentStep === 1) startTimer(1, 3);
            else if (currentStep === 2) startTimer(2, 5);
            else if (currentStep === 3) startTimer(3, 5);
            else if (currentStep === 4) startTimer(4, 7);
        }

        function prevStep() {
            if (currentStep > 0) {
                collectDataForStep(currentStep);
                currentStep--;
                showStep(currentStep);
            }
        }

        function generateResult() {
            collectDataForStep(4);
            
            stopAllTimers();
            currentStep = 5;
            showStep(5);
            
            const renderContent = (content) => content ? content.replace(/\n/g, '<br>') : '<em>æœªå¡«å†™</em>';

            document.getElementById('finalResult').innerHTML = `
                <h3>ä½ çš„åˆ›æ„æ„æ€</h3>
                <div class="result-item"><div class="result-label">ä¸»é¢˜</div><div class="result-content">${renderContent(data.theme)}</div></div>
                <div class="result-item"><div class="result-label">æ ¸å¿ƒé”šç‚¹</div><div class="result-content">${renderContent(data.anchor)}</div></div>
                <div class="result-item"><div class="result-label">é€‰æ‹©ç†ç”±</div><div class="result-content">${renderContent(data.anchorReason)}</div></div>
                <div class="result-item"><div class="result-label">æ„å¤–å±æ€§</div><div class="result-content">${renderContent(data.unexpectedAttr)}</div></div>
                <div class="result-item"><div class="result-label">äººç‰©å…³ç³»</div><div class="result-content">${renderContent(data.relationship)}</div></div>
                <div class="result-item"><div class="result-label">å‰æœŸæ°›å›´</div><div class="result-content">${renderContent(data.atmosphere)}</div></div>
                <div class="result-item"><div class="result-label">è§‚ä¼—é¢„æœŸ</div><div class="result-content">${renderContent(data.expectation)}</div></div>
                <div class="result-item"><div class="result-label">åè½¬è®¾è®¡</div><div class="result-content"><b>åè½¬ç‚¹ï¼š</b><br>${renderContent(data.twistPoint)}<br><br><b>åè½¬å†…å®¹ï¼š</b><br>${renderContent(data.twistContent)}</div></div>
                <div class="result-item"><div class="result-label">æƒ…ç»ªå¼§çº¿</div><div class="result-content">${renderContent(data.emotionArc)}</div></div>
            `;
        }

        function fillSuggestion(fieldId, value) {
            const field = document.getElementById(fieldId);
            field.value = value;
            field.focus();
        }

        function exportResult() {
            const dataToExport = [
                { label: "ä¸»é¢˜", content: data.theme },
                { label: "æ ¸å¿ƒé”šç‚¹", content: data.anchor },
                { label: "é€‰æ‹©ç†ç”±", content: data.anchorReason },
                { label: "æ„å¤–å±æ€§", content: data.unexpectedAttr },
                { label: "äººç‰©å…³ç³»", content: data.relationship },
                { label: "å‰æœŸæ°›å›´", content: data.atmosphere },
                { label: "è§‚ä¼—é¢„æœŸ", content: data.expectation },
                { label: "åè½¬ç‚¹", content: data.twistPoint },
                { label: "åè½¬å†…å®¹", content: data.twistContent },
                { label: "æƒ…ç»ªå¼§çº¿", content: data.emotionArc },
            ];

            const formattedContent = dataToExport
                .map(item => `${item.label}:\n${item.content || 'æœªå¡«å†™'}\n`)
                .join('\n--------------------\n\n');

            const blob = new Blob([formattedContent], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `åˆ›æ„æ„æ€_${data.theme || 'æœªå‘½å'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function restart() {
            currentStep = 0;
            data = {};
            stopAllTimers();
            
            document.querySelectorAll('input, textarea').forEach(input => input.value = '');
            document.getElementById('floatingSummary').classList.remove('visible');
            showStep(0);
        }

        document.addEventListener('DOMContentLoaded', () => {
            showStep(0);
        });
    </script>
</body>
</html>